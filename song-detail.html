<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thành Phố Buồn - Đàm Vĩnh Hưng - Kalimba Chill</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/logo.jpeg" type="image/jpeg">
    
    <!-- Script để xóa bộ nhớ cache -->
    <script src="js/clear-cache.js"></script>
    <script src="js/auth-watchdog.js"></script>
    <script src="js/auth-login-helper.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/firebase-constants.js"></script>
    <script src="js/firebase-debug.js"></script>
    
    <!-- Firebase App (cần thiết cho tất cả các sản phẩm của Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    
    <!-- Thêm các SDK Firebase mà bạn muốn sử dụng -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Scripts tùy chỉnh -->
    <script src="js/firebase-auth.js"></script>
    <script src="js/firestore-operations.js"></script>
    <script src="js/script.js"></script>
</head>
<body>
    <div class="container">
        <header class="song-detail-header">
            <div class="header-left">
                <button class="menu-btn" id="menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
             
            </div>
            <div class="header-center">
                <h1>
                    
                    <span class="logo-text">Tên bài hát</span>
                </h1>
                <div class="song-actions">
                    <button class="heart-btn" id="heart-favorite-btn" title="Thêm vào yêu thích">
                        <i class="far fa-heart"></i>
                    </button>
                    <button class="share-btn" id="share-song-btn" title="Chia sẻ bài hát">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
            </div>
            <div class="header-right">
                <div class="header-avatar">
                    <!-- User avatar sẽ được thêm tự động vào đây bởi javascript -->
                </div>
                <!-- Các nút khác nếu có -->
            </div>
        </header>

        <div class="song-meta">
            <div class="song-info">
                <!-- Các thông tin meta của bài hát đã được loại bỏ -->
            </div>
        </div>

        <main class="song-content">
            <div class="chord-sheet">
                <!-- Nội dung hợp âm sẽ được tải từ Firebase -->
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Đang tải hợp âm bài hát...</span>
                </div>
            </div>
            
            <div class="song-lyrics-and-notes">
                <!-- Lời bài hát và nốt nhạc sẽ được hiển thị ở đây, xen kẽ nhau -->
            </div>
        </main>


    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fab fa-google"></i>
                </div>
                <button class="login-with-google-btn">
                    <i class="fab fa-google"></i> Đăng nhập bằng Google
                </button>
            </div>
        </div>
        <nav class="sidebar-menu">
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> Trang chủ</a></li>
              
                <li><a href="favorites.html"><i class="fas fa-heart"></i> Yêu thích</a></li>
               
                <li><a href="index.html#donate"><i class="fas fa-hand-holding-heart"></i> Đóng góp</a></li>
                <li><a href="feedback.html"><i class="fas fa-comment-dots"></i> Góp ý</a></li>
             
            </ul>
        </nav>
    </div>
    <div class="overlay" id="overlay"></div>
    
    <!-- Thêm user-menu và overlay cho menu này -->
    <div class="user-menu-overlay" style="display: none;"></div>
    <div id="user-menu" class="user-menu">
        <div class="user-menu-header">
            <div class="user-avatar"></div>
            <div class="user-info">
                <div class="user-name">Chưa đăng nhập</div>
                <div class="user-email"></div>
            </div>
        </div>
        <div class="user-menu-items">
            <a href="favorites.html" class="user-menu-item">
                <i class="fas fa-heart"></i> Bài hát yêu thích
            </a>
            <a href="#" class="user-menu-item">
                <i class="fas fa-list"></i> Playlist của tôi
            </a>
            <a href="#" class="user-menu-item">
                <i class="fas fa-history"></i> Đã xem gần đây
            </a>
            <a href="#" class="user-menu-item logout">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </a>
        </div>
    </div>

    <!-- Firebase App (cần thiết cho tất cả các sản phẩm của Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    
    <!-- Thêm các SDK Firebase mà bạn muốn sử dụng -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Scripts tùy chỉnh -->
    <script src="js/firebase-auth.js"></script>
    <script src="js/firestore-operations.js"></script>
    <script src="js/script.js"></script>
    
    <!-- Firebase initialization -->
    <script>
        // Khởi tạo Firebase với cấu hình từ firebase-constants.js
        document.addEventListener('DOMContentLoaded', function() {
            // Lấy cấu hình từ firebase-constants.js
            const firebaseConfig = window.getFirebaseConfig();
            
            // Khởi tạo Firebase nếu chưa được khởi tạo
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log('Firebase đã được khởi tạo thành công từ firebase-constants.js');
                
                // Khởi tạo Analytics nếu có id
                if (firebaseConfig.measurementId) {
                    firebase.analytics();
                }
            }
        });
    </script>
    
    <!-- Script xử lý chi tiết bài hát -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Lấy ID bài hát từ URL
            const urlParams = new URLSearchParams(window.location.search);
            const songId = urlParams.get('id');
            
            if (!songId) {
                console.error('Không tìm thấy ID bài hát trong URL.');
                document.querySelector('.song-content').innerHTML = 
                    '<div class="error-message">Không tìm thấy thông tin bài hát. <a href="songs.html">Quay lại danh sách</a></div>';
                return;
            }
            
            // Hiển thị trạng thái đang tải
            document.querySelector('.song-content').innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Đang tải chi tiết bài hát...</span>
                    </div>
                </div>
            `;
            
            // Khởi tạo Firebase nếu chưa được khởi tạo
            try {
                await waitForFirebase();
                
                // Tải dữ liệu bài hát trực tiếp từ Firestore
                await loadSongDetails(songId);
                
                // Thiết lập các tương tác
                setupInteractions(songId);
                
            } catch (error) {
                console.error('Lỗi khi tải chi tiết bài hát:', error);
                document.querySelector('.song-content').innerHTML = `
                    <div class="error-message">
                        <h3>Đã xảy ra lỗi</h3>
                        <p>Không thể tải thông tin bài hát. Vui lòng thử lại sau.</p>
                        <p>Chi tiết lỗi: ${error.message || 'Không xác định'}</p>
                        <p><a href="songs.html" class="btn"><i class="fas fa-arrow-left"></i> Quay lại danh sách bài hát</a></p>
                    </div>
                `;
                
                // Cập nhật tiêu đề
                document.title = 'Lỗi - Kalimba Chill';
            }
        });
        
        // Tải chi tiết bài hát
        async function loadSongDetails(songId) {
            console.log(`Đang tải chi tiết bài hát với ID: ${songId}`);
            
            try {
                let song = null;
                
                // Thử sử dụng hàm getSongDetails từ firestoreOperations
                if (window.firestoreOperations && typeof window.firestoreOperations.getSongDetails === 'function') {
                    console.log('Sử dụng firestoreOperations.getSongDetails');
                    song = await window.firestoreOperations.getSongDetails(songId);
                } else {
                    console.log('Truy vấn trực tiếp từ Firestore');
                    // Truy vấn trực tiếp từ Firestore
                    const db = firebase.firestore();
                    const songDoc = await db.collection('songs').doc(songId).get();
                    
                    if (!songDoc.exists) {
                        throw new Error('Không tìm thấy bài hát với ID: ' + songId);
                    }
                    
                    song = {
                        id: songDoc.id,
                        ...songDoc.data()
                    };
                }
                
                if (!song) {
                    throw new Error('Không tìm thấy bài hát với ID: ' + songId);
                }
                
                console.log('Đã tải bài hát:', song);
                
                // Thêm bài hát vào danh sách xem gần đây
                if (typeof addToRecentlyViewed === 'function') {
                    addToRecentlyViewed(songId, song.title, song.artist);
                } else {
                    console.warn('Không tìm thấy hàm addToRecentlyViewed, bỏ qua lưu vào xem gần đây');
                }
                
                // Cập nhật tiêu đề trang
                document.title = `${song.title || 'Bài hát'} - Kalimba Chill`;
                
                // Cập nhật tiêu đề trong header
                const logoText = document.querySelector('.logo-text');
                if (logoText) {
                    logoText.textContent = song.title || 'Kalimba Chill';
                }
                
                // Cập nhật meta description và og tags cho SEO và chia sẻ
                const metaDescription = document.querySelector('meta[name="description"]');
                if (metaDescription) {
                    metaDescription.setAttribute('content', `Hợp âm và tab đàn Kalimba cho bài hát ${song.title} - ${song.artist || 'Various Artists'}`);
                }
                
                // Cập nhật OpenGraph tags cho việc chia sẻ
                let ogTitle = document.querySelector('meta[property="og:title"]');
                if (!ogTitle) {
                    ogTitle = document.createElement('meta');
                    ogTitle.setAttribute('property', 'og:title');
                    document.head.appendChild(ogTitle);
                }
                ogTitle.setAttribute('content', `${song.title} - Kalimba Chill`);
                
                let ogDescription = document.querySelector('meta[property="og:description"]');
                if (!ogDescription) {
                    ogDescription = document.createElement('meta');
                    ogDescription.setAttribute('property', 'og:description');
                    document.head.appendChild(ogDescription);
                }
                ogDescription.setAttribute('content', `Hợp âm và tab đàn Kalimba cho bài hát ${song.title} - ${song.artist || 'Various Artists'}`);
                
                // Thay thế nội dung loading bằng thông tin bài hát
                const songContent = document.querySelector('.song-content');
                songContent.innerHTML = `
                   
                      
                    </div>
                    
                 
                    
                    <div class="song-tab-container">
                        <h2 class="section-title">Tab và lời bài hát</h2>
                        <div class="song-lyrics-and-notes">
                            ${formatLyricsAndNotes(song.lyrics, song.notes)}
                        </div>
                    </div>
                `;
                
                // Kiểm tra trạng thái yêu thích và cập nhật nút
                try {
                    // Kiểm tra từ localStorage trước
                    let favorites = [];
                    const favoritesJson = localStorage.getItem('kalimbaFavorites');
                    if (favoritesJson) {
                        favorites = JSON.parse(favoritesJson);
                    }
                    
                    const isFavorite = favorites.includes(songId);
                    console.log('Trạng thái yêu thích của bài hát:', songId, isFavorite);
                    updateFavoriteButton(isFavorite);
                    
                    // Đồng bộ với userFavorites trong firestoreOperations nếu có
                    if (window.firestoreOperations && window.firestoreOperations.userFavorites) {
                        if (!window.firestoreOperations.userFavorites.includes(songId) && isFavorite) {
                            window.firestoreOperations.userFavorites.push(songId);
                        }
                    }
                } catch (error) {
                    console.warn('Lỗi khi kiểm tra trạng thái yêu thích:', error);
                }
                
                return song;
            } catch (error) {
                console.error('Lỗi khi tải chi tiết bài hát:', error);
                throw error;
            }
        }
        
        // Chờ Firebase được khởi tạo
        function waitForFirebase(timeout = 10000) {
            return new Promise((resolve, reject) => {
                const start = Date.now();
                
                const checkFirebase = () => {
                    if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                        console.log('Firebase đã được khởi tạo');
                        resolve();
                        return;
                    }
                    
                    if (Date.now() - start > timeout) {
                        console.error('Timeout khi chờ Firebase khởi tạo');
                        reject(new Error('Timeout khi chờ Firebase khởi tạo'));
                        return;
                    }
                    
                    console.log('Đang chờ Firebase khởi tạo...');
                    setTimeout(checkFirebase, 500);
                };
                
                checkFirebase();
            });
        }
        
        // Định dạng hợp âm từ dữ liệu
        function formatChordSheet(chordSheet) {
            console.log('Dữ liệu chordSheet để hiển thị:', chordSheet);
            
            // Nếu không có dữ liệu
            if (chordSheet === null || chordSheet === undefined) {
                return `
                    <div class="message-box">
                        <p>Hợp âm của bài hát này hiện chưa có.</p>
                    </div>
                `;
            }
            
            // Nếu đã là HTML (string)
            if (typeof chordSheet === 'string') {
                // Nếu là chuỗi rỗng hoặc chỉ có khoảng trắng
                if (!chordSheet.trim()) {
                    return `
                        <div class="message-box">
                            <p>Hợp âm của bài hát này hiện chưa có.</p>
                        </div>
                    `;
                }
                return chordSheet;
            }
            
            // Nếu là mảng đơn giản (không phải đối tượng đặc biệt cho chord)
            if (Array.isArray(chordSheet) && chordSheet.every(item => typeof item === 'string')) {
                return `
                    <div class="chord-simple">
                        ${chordSheet.map(line => `<div class="line"><span class="lyric">${line}</span></div>`).join('')}
                    </div>
                `;
            }
            
            // Nếu là mảng các đoạn phức tạp
            if (Array.isArray(chordSheet)) {
                let html = '';
                
                // Xử lý intro nếu có và đúng định dạng
                if (chordSheet.intro && typeof chordSheet.intro === 'string') {
                    html += `<h3>Intro: ${chordSheet.intro}</h3>`;
                }
                
                // Xử lý từng đoạn
                chordSheet.forEach(section => {
                    if (!section || typeof section !== 'object') {
                        return; // Bỏ qua phần tử không hợp lệ
                    }
                    
                    // Xác định loại đoạn
                    if (section.type === 'verse') {
                        html += '<div class="verse">';
                    } else if (section.type === 'chorus') {
                        html += '<div class="chorus">';
                    } else {
                        html += '<div class="section">';
                    }
                    
                    // Thêm tiêu đề nếu có
                    if (section.title && typeof section.title === 'string') {
                        html += `<h4>${section.title}</h4>`;
                    }
                    
                    // Xử lý từng dòng
                    if (Array.isArray(section.lines)) {
                        section.lines.forEach(line => {
                            html += '<div class="line">';
                            
                            // Nếu dòng là chuỗi đơn giản
                            if (typeof line === 'string') {
                                html += `<span class="lyric">${line}</span>`;
                            } 
                            // Nếu dòng là mảng các phần tử (hợp âm + lời)
                            else if (Array.isArray(line)) {
                                line.forEach(part => {
                                    if (!part || typeof part !== 'object') {
                                        return; // Bỏ qua phần tử không hợp lệ
                                    }
                                    
                                    if (part.chord) {
                                        html += `<span class="chord">[${part.chord}]</span>`;
                                    }
                                    if (part.lyric) {
                                        html += `<span class="lyric">${part.lyric}</span>`;
                                    }
                                });
                            }
                            
                            html += '</div>'; // Đóng .line
                        });
                    }
                    
                    html += '</div>'; // Đóng .verse hoặc .chorus
                });
                
                if (html) {
                    return html;
                } else {
                    return `
                        <div class="message-box">
                            <p>Định dạng hợp âm không hỗ trợ.</p>
                        </div>
                    `;
                }
            }
            
            // Xử lý đối tượng đơn giản
            if (typeof chordSheet === 'object' && chordSheet !== null) {
                try {
                    // Thử chuyển đối tượng thành chuỗi JSON để hiển thị
                    const jsonString = JSON.stringify(chordSheet, null, 2);
                    return `
                        <div class="chord-debug">
                            <p><strong>Dữ liệu hợp âm (định dạng chưa được xử lý):</strong></p>
                            <pre>${jsonString}</pre>
                        </div>
                    `;
                } catch (e) {
                    console.error('Lỗi khi chuyển đối tượng thành JSON:', e);
                }
            }
            
            // Trường hợp không xử lý được
            return `
                <div class="message-box">
                    <p>Định dạng hợp âm không hỗ trợ.</p>
                </div>
            `;
        }
        
        // Định dạng lời bài hát và nốt nhạc xen kẽ nhau
        function formatLyricsAndNotes(lyrics, notes) {
            console.log('Dữ liệu lyrics và notes để hiển thị:', lyrics, notes);
            
            // Nếu không có dữ liệu
            if (!lyrics && !notes) {
                return `
                    <div class="message-box">
                        <p>Lời bài hát và nốt nhạc của bài hát này hiện chưa có.</p>
                    </div>
                `;
            }
            
            // Tạo tiêu đề cho phần này
            let html = `<h3></h3>`;
            
            // Xử lý phần lời bài hát và nốt nhạc xen kẽ nhau
            html += '<div class="lyrics-content">';
            
            // Xử lý lời bài hát thành mảng
            let lyricsLines = [];
            if (lyrics) {
                if (Array.isArray(lyrics)) {
                    lyricsLines = lyrics;
                } else if (typeof lyrics === 'string') {
                    lyricsLines = lyrics.split('\n').filter(line => line.trim());
                }
            }
            
            // Xử lý nốt nhạc thành mảng
            let notesLines = [];
            if (notes) {
                if (Array.isArray(notes)) {
                    notesLines = notes;
                } else if (typeof notes === 'string') {
                    notesLines = notes.split('\n').filter(line => line.trim());
                }
            }
            
            // Xác định độ dài tối đa giữa lyrics và notes
            const maxLength = Math.max(lyricsLines.length, notesLines.length);
            
            // Hiển thị lời bài hát và nốt nhạc xen kẽ nhau
            for (let i = 0; i < maxLength; i++) {
                // Hiển thị dòng lời bài hát nếu có
                if (i < lyricsLines.length) {
                    html += `<div class="lyrics-line">${lyricsLines[i] || ''}</div>`;
                }
                
                // Hiển thị dòng nốt nhạc nếu có
                if (i < notesLines.length) {
                    html += `<div class="notes-line">${notesLines[i] || ''}</div>`;
                }
            }
            
            html += '</div>';
            return html;
        }
        
        // Cập nhật trạng thái nút yêu thích
        function updateFavoriteButton(isFavorite) {
            const favoriteBtn = document.getElementById('heart-favorite-btn');
            if (!favoriteBtn) return;
            
            const icon = favoriteBtn.querySelector('i');
            
            if (isFavorite) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.style.color = '#e74c3c'; // Màu đỏ khi đã yêu thích
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                icon.style.color = ''; // Màu mặc định
            }
        }
        
        // Thiết lập các tương tác
        function setupInteractions(songId) {
            // Nút yêu thích dưới tên bài hát (heart icon)
            const heartBtn = document.getElementById('heart-favorite-btn');
            if (heartBtn) {
                heartBtn.dataset.songId = songId;
                heartBtn.addEventListener('click', async () => toggleSongFavorite(songId));
            }
            
            // Nút chia sẻ
            const shareBtn = document.getElementById('share-song-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', () => {
                    shareSong();
                });
            }
            
            // Nút menu (mobile)
            const menuBtn = document.querySelector('.menu-btn');
            if (menuBtn) {
                menuBtn.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    if (sidebar && overlay) {
                        sidebar.classList.add('active');
                        overlay.classList.add('active');
                        
                        // Cập nhật avatar trong sidebar
                        updateSidebarAvatar();
                    }
                });
            }
            
            // Nút quay lại
            const backBtn = document.querySelector('.back-btn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    window.history.back();
                });
            }
            
            // Overlay - đóng sidebar khi click vào overlay
            const overlay = document.getElementById('overlay');
            if (overlay) {
                overlay.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                    }
                });
            }
        }
        
        // Cập nhật avatar trong sidebar
        function updateSidebarAvatar() {
            const sidebarAvatar = document.querySelector('.sidebar .user-avatar');
            if (!sidebarAvatar) return;
            
            // Kiểm tra người dùng đã đăng nhập chưa
            const savedUser = localStorage.getItem('kalimbaUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    if (userData && userData.picture) {
                        sidebarAvatar.innerHTML = `<img src="${userData.picture}" alt="${userData.name}" style="width: 100%; height: 100%; object-fit: cover;">`;
                        
                        // Cập nhật nút đăng nhập
                        const loginBtn = sidebarAvatar.closest('.sidebar-header').querySelector('.login-with-google-btn');
                        if (loginBtn) {
                            loginBtn.style.display = 'none';
                            
                            // Hiển thị tên người dùng nếu có thể
                            if (userData.name) {
                                const userProfile = sidebarAvatar.closest('.user-profile');
                                if (userProfile) {
                                    if (!userProfile.querySelector('.user-name')) {
                                        const userName = document.createElement('div');
                                        userName.className = 'user-name';
                                        userName.textContent = userData.name;
                                        userName.style.margin = '10px 0';
                                        userName.style.fontWeight = 'bold'; 
                                        userProfile.appendChild(userName);
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Lỗi khi đọc thông tin người dùng:', error);
                }
            }
        }
        
        // Hàm toggle yêu thích (dùng cho cả nút star và heart)
        async function toggleSongFavorite(songId) {
            try {
                // Nếu có hàm toggleFavoriteSong trong firestore-operations.js, sử dụng nó
                if (window.firestoreOperations && typeof window.firestoreOperations.toggleFavoriteSong === 'function') {
                    const isFavorite = await window.firestoreOperations.toggleFavoriteSong(songId);
                    
                    // Nếu hàm trả về null, có thể người dùng chưa đăng nhập
                    if (isFavorite === null) {
                        return;
                    }
                    
                    // Cập nhật trạng thái nút
                    updateAllFavoriteButtons(isFavorite);
                    
                    // Hiển thị thông báo
                    if (isFavorite) {
                        if (window.firebaseUtils && window.firebaseUtils.showAlert) {
                            window.firebaseUtils.showAlert('Đã thêm vào danh sách yêu thích', 'success');
                        } else {
                            showMessage('Đã thêm vào danh sách yêu thích', 'success');
                        }
                    } else {
                        if (window.firebaseUtils && window.firebaseUtils.showAlert) {
                            window.firebaseUtils.showAlert('Đã xóa khỏi danh sách yêu thích', 'info');
                        } else {
                            showMessage('Đã xóa khỏi danh sách yêu thích', 'info');
                        }
                    }
                } else {
                    // Nếu không có hàm có sẵn, tự xử lý 
                    console.error('Hàm toggleFavoriteSong không tồn tại, xử lý thủ công');
                    // Lấy danh sách yêu thích hiện tại
                    let favorites = [];
                    try {
                        const favoritesJson = localStorage.getItem('kalimbaFavorites');
                        if (favoritesJson) {
                            favorites = JSON.parse(favoritesJson);
                        }
                    } catch (e) {
                        favorites = [];
                    }
                    
                    // Kiểm tra xem bài hát đã yêu thích chưa
                    const heartBtn = document.getElementById('heart-favorite-btn');
                    const icon = heartBtn.querySelector('i');
                    const isFavorite = icon.classList.contains('fas');
                    
                    if (isFavorite) {
                        // Xóa khỏi yêu thích
                        favorites = favorites.filter(id => id !== songId);
                        localStorage.setItem('kalimbaFavorites', JSON.stringify(favorites));
                        updateAllFavoriteButtons(false);
                        showMessage('Đã xóa khỏi danh sách yêu thích', 'info');
                    } else {
                        // Thêm vào yêu thích
                        if (!favorites.includes(songId)) {
                            favorites.push(songId);
                        }
                        localStorage.setItem('kalimbaFavorites', JSON.stringify(favorites));
                        updateAllFavoriteButtons(true);
                        showMessage('Đã thêm vào danh sách yêu thích', 'success');
                    }
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật trạng thái yêu thích:', error);
                if (window.firebaseUtils && window.firebaseUtils.showAlert) {
                    window.firebaseUtils.showAlert('Đã xảy ra lỗi khi cập nhật trạng thái yêu thích', 'error');
                } else {
                    showMessage('Đã xảy ra lỗi khi cập nhật trạng thái yêu thích', 'error');
                }
            }
        }
        
        // Cập nhật tất cả các nút yêu thích
        function updateAllFavoriteButtons(isFavorite) {
            // Cập nhật nút yêu thích với icon trái tim
            const heartBtn = document.getElementById('heart-favorite-btn');
            if (heartBtn) {
                const icon = heartBtn.querySelector('i');
                if (isFavorite) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    icon.style.color = '#e74c3c'; // Màu đỏ khi đã yêu thích
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    icon.style.color = ''; // Màu mặc định
                }
            }
        }
        
        // Hàm chia sẻ bài hát (copy link)
        function shareSong() {
            // Lấy URL hiện tại
            const currentUrl = window.location.href;
            
            // Copy URL vào clipboard
            navigator.clipboard.writeText(currentUrl).then(() => {
                // Tạo thông báo
                showCopyNotification('Đã sao chép liên kết. Bạn có thể chia sẻ với bạn bè!');
            }).catch(err => {
                console.error('Không thể sao chép liên kết:', err);
                window.firebaseUtils.showAlert('Không thể sao chép liên kết', 'error');
            });
        }
        
        // Hiển thị thông báo đã sao chép
        function showCopyNotification(message) {
            // Kiểm tra xem đã có thông báo chưa
            let notification = document.querySelector('.copy-notification');
            
            // Nếu chưa có, tạo mới
            if (!notification) {
                notification = document.createElement('div');
                notification.className = 'copy-notification';
                document.body.appendChild(notification);
            }
            
            // Cập nhật nội dung và hiển thị
            notification.textContent = message;
            notification.style.display = 'block';
            
            // Tự động ẩn sau 2 giây
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        // Thiết lập sự kiện cho các phần tương tác
        document.addEventListener('DOMContentLoaded', function() {
            // Thiết lập tương tác với các phần tử trên trang
            setupInteractions();
            
            // Khởi tạo sự kiện đăng nhập
            if (typeof attachLoginEvents === 'function') {
                attachLoginEvents();
            } else {
                // Đợi nếu Google Auth script chưa được tải
                setTimeout(function() {
                    if (typeof attachLoginEvents === 'function') {
                        attachLoginEvents();
                    }
                }, 1000);
            }
        });

        // Hiển thị thông báo nếu không có firebaseUtils.showAlert
        function showMessage(message, type = 'info', duration = 3000) {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type}`;
            alertContainer.innerHTML = message;
            
            document.body.appendChild(alertContainer);
            
            // Hiển thị thông báo
            setTimeout(() => {
                alertContainer.classList.add('show');
            }, 10);
            
            // Ẩn thông báo sau thời gian chỉ định
            setTimeout(() => {
                alertContainer.classList.add('fade-out');
                
                // Xóa thông báo khỏi DOM sau khi animation kết thúc
                setTimeout(() => {
                    alertContainer.remove();
                }, 300);
            }, duration);
        }
    </script>
</body>
</html> 