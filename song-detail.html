<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thành Phố Buồn - Đàm Vĩnh Hưng - Kalimba Chill</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/logo.jpeg" type="image/jpeg">
    
    <!-- Firebase App (cần thiết cho tất cả các sản phẩm của Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    
    <!-- Thêm các SDK Firebase mà bạn muốn sử dụng -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Scripts tùy chỉnh -->
    <script src="js/env-loader.js"></script>
</head>
<body>
    <div class="container">
        <header class="song-detail-header">
            <div class="header-left">
                <button class="menu-btn" id="menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="back-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="header-center">
                <h1>
                    <img src="images/kalimba-chill-logo.jpg" alt="Kalimba Chill Logo" class="mobile-logo">
                    <span class="logo-text">Thành Phố Buồn</span>
                </h1>
            </div>
            <div class="header-right">
                <button class="favorite-btn">
                    <i class="far fa-star"></i>
                </button>
                <button class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
            </div>
        </header>

        <div class="song-meta">
            <div class="artist">Đàm Vĩnh Hưng</div>
            <div class="song-info">
                <span class="tone">Tone: Em</span>
                <span class="separator">|</span>
                <span class="capo">Capo: 0</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn tone-up"><i class="fas fa-arrow-up"></i> Tăng Tone</button>
            <button class="btn tone-down"><i class="fas fa-arrow-down"></i> Giảm Tone</button>
            <button class="btn transpose"><i class="fas fa-exchange-alt"></i> Chuyển Tone</button>
        </div>

        <div class="tab-controls">
            <button class="tab-btn active">Hợp Âm</button>
            <button class="tab-btn">Tab Kalimba</button>
            <button class="tab-btn">Lời Bài Hát</button>
        </div>

        <main class="song-content">
            <div class="chord-sheet">
                <h3>Intro: [Em] [C] [Am] [Em] [B7] [Em]</h3>
                
                <div class="verse">
                    <div class="line">
                        <span class="chord">[Em]</span>
                        <span class="lyric">Thành phố nào nhớ không</span>
                        <span class="chord">[G]</span>
                        <span class="lyric">em?</span>
                    </div>
                    <div class="line">
                        <span class="lyric">Nơi chúng mình quen nhau</span>
                    </div>
                    <div class="line">
                        <span class="chord">[C]</span>
                        <span class="lyric">Thành phố nào vui không</span>
                        <span class="chord">[Am]</span>
                        <span class="lyric">em?</span>
                    </div>
                    <div class="line">
                        <span class="lyric">Khi chúng mình xa nhau</span>
                    </div>
                </div>
                
                <div class="verse">
                    <div class="line">
                        <span class="chord">[Em]</span>
                        <span class="lyric">Thành phố buồn khi hai đứa</span>
                        <span class="chord">[Am]</span>
                        <span class="lyric">mình</span>
                    </div>
                    <div class="line">
                        <span class="chord">[D]</span>
                        <span class="lyric">Chưa</span>
                        <span class="chord">[G]</span>
                        <span class="lyric">bao giờ</span>
                        <span class="chord">[B7]</span>
                        <span class="lyric">gặp nhau</span>
                    </div>
                    <div class="line">
                        <span class="chord">[Em]</span>
                        <span class="lyric">Em ở nơi</span>
                        <span class="chord">[C]</span>
                        <span class="lyric">nào?</span>
                    </div>
                    <div class="line">
                        <span class="chord">[Am]</span>
                        <span class="lyric">Anh đi tìm</span>
                        <span class="chord">[B7]</span>
                        <span class="lyric">em về</span>
                    </div>
                </div>
            </div>

            <div class="kalimba-tab" style="display: none;">
                <h3>Tab Kalimba - Thành Phố Buồn</h3>
                
                <div class="tab-intro">
                    <p>Sử dụng Kalimba 17 phím, thang âm C Major</p>
                </div>
                
                <div class="tab-notation">
                    <pre>
Intro: 
2 2' 3' 4' 3' 2'
5 5 6 7 6 5

Verse 1:
2 2' 3' 4' 3' 2'
5 5 6 7 6 5
1' 1' 7 6 5 6
7 6 5 3 2

Chorus:
5 5 6 7 1' 2'
3 3 4 5 6 7
2' 2' 3' 4' 3' 2'
1' 7 6 5 3 2
                    </pre>
                </div>
                
                <div class="tab-note">
                    <p>Chú thích:</p>
                    <ul>
                        <li>Số không có dấu: Phím trung tâm và thấp</li>
                        <li>Số có dấu ': Phím cao</li>
                    </ul>
                </div>
            </div>

            <div class="lyrics-only" style="display: none;">
                <h3>Lời bài hát - Thành Phố Buồn</h3>
                
                <div class="lyrics">
                    <p>Thành phố nào nhớ không em?<br>
                    Nơi chúng mình quen nhau<br>
                    Thành phố nào vui không em?<br>
                    Khi chúng mình xa nhau</p>

                    <p>Thành phố buồn khi hai đứa mình<br>
                    Chưa bao giờ gặp nhau<br>
                    Em ở nơi nào?<br>
                    Anh đi tìm em về</p>

                    <p>Biết đâu tình cờ<br>
                    Em có về ngang qua<br>
                    Thành phố này vẫn buồn<br>
                    Mây hắt hiu bay về chiều</p>

                    <p>Biết đâu tình cờ<br>
                    Em có nhìn thấy anh<br>
                    Thành phố này vẫn đau<br>
                    Con tim hoài mong nhớ</p>
                </div>
            </div>
        </main>

        <div class="footer-actions">
            <button class="action-btn">
                <i class="fas fa-play"></i>
                <span>Nghe bài hát</span>
            </button>
            <button class="action-btn">
                <i class="fas fa-download"></i>
                <span>Tải xuống</span>
            </button>
            <button class="action-btn">
                <i class="fas fa-comments"></i>
                <span>Bình luận</span>
            </button>
        </div>

        <div class="footer-links">
            <h3>Liên kết</h3>
            <ul>
                <li><a href="index.html">Trang chủ</a></li>
                <li><a href="#">Danh sách bài hát</a></li>
                <li><a href="#">Khóa học</a></li>
                <li><a href="index.html#donate">Đóng góp</a></li>
                <li><a href="feedback.html">Góp ý</a></li>
            </ul>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fab fa-google"></i>
                </div>
                <button class="login-with-google-btn">
                    <i class="fab fa-google"></i> Đăng nhập bằng Google
                </button>
            </div>
        </div>
        <nav class="sidebar-menu">
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> Trang chủ</a></li>
                <li><a href="songs.html"><i class="fas fa-music"></i> Bài hát</a></li>
                <li><a href="#"><i class="fas fa-book"></i> Khóa học</a></li>
                <li><a href="#"><i class="fas fa-list"></i> Playlist của tôi</a></li>
                <li><a href="#"><i class="fas fa-heart"></i> Yêu thích</a></li>
                <li><a href="#"><i class="fas fa-search"></i> Tìm theo hợp âm</a></li>
                <li><a href="#"><i class="fas fa-guitar"></i> Tra cứu hợp âm</a></li>
                <li><a href="index.html#donate"><i class="fas fa-hand-holding-heart"></i> Đóng góp</a></li>
                <li><a href="feedback.html"><i class="fas fa-comment-dots"></i> Góp ý</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> Thiết lập</a></li>
            </ul>
        </nav>
    </div>
    <div class="overlay" id="overlay"></div>

    <script src="js/script.js"></script>
    
    <!-- Firebase initialization -->
    <script type="module">
        // Khởi tạo Firebase dựa trên cấu hình từ env-loader.js
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra xem đã tải được cấu hình chưa
            setTimeout(() => {
                const firebaseConfig = window.getFirebaseConfig ? window.getFirebaseConfig() : {
                    apiKey: window.getEnv ? window.getEnv('FIREBASE_API_KEY') : '',
                    authDomain: window.getEnv ? window.getEnv('FIREBASE_AUTH_DOMAIN') : '',
                    projectId: window.getEnv ? window.getEnv('FIREBASE_PROJECT_ID') : '',
                    storageBucket: window.getEnv ? window.getEnv('FIREBASE_STORAGE_BUCKET') : '',
                    messagingSenderId: window.getEnv ? window.getEnv('FIREBASE_MESSAGING_SENDER_ID') : '',
                    appId: window.getEnv ? window.getEnv('FIREBASE_APP_ID') : '',
                    measurementId: window.getEnv ? window.getEnv('FIREBASE_MEASUREMENT_ID') : ''
                };
                
                // Khởi tạo Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('Firebase đã được khởi tạo thành công.');
                }
            }, 1000); // Đợi 1 giây để đảm bảo env-loader đã chạy
        });
    </script>
    
    <!-- Firebase authentication -->
    <script type="module" src="js/firebase-auth.js"></script>
    
    <!-- Firestore operations -->
    <script type="module" src="js/firestore-operations.js"></script>
    
    <!-- Script xử lý chi tiết bài hát -->
    <script type="module">
        import { 
            getSongDetails, 
            checkFavoriteStatus, 
            toggleFavoriteSong,
            saveRecentView
        } from './js/firestore-operations.js';
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Lấy ID bài hát từ URL
            const urlParams = new URLSearchParams(window.location.search);
            const songId = urlParams.get('id');
            
            if (!songId) {
                console.error('Không tìm thấy ID bài hát trong URL.');
                document.querySelector('.song-content').innerHTML = 
                    '<div class="error-message">Không tìm thấy thông tin bài hát. <a href="songs.html">Quay lại danh sách</a></div>';
                return;
            }
            
            try {
                // Tải thông tin chi tiết bài hát từ Firestore
                const song = await getSongDetails(songId);
                
                if (!song) {
                    console.error('Không tìm thấy thông tin bài hát với ID:', songId);
                    document.querySelector('.song-content').innerHTML = 
                        '<div class="error-message">Không tìm thấy thông tin bài hát. <a href="songs.html">Quay lại danh sách</a></div>';
                    return;
                }
                
                // Cập nhật tiêu đề trang và thông tin meta
                document.title = `${song.title} - ${song.artist} - Kalimba Chill`;
                document.querySelector('.logo-text').textContent = song.title;
                document.querySelector('.artist').textContent = song.artist;
                
                // Cập nhật thông tin tone và capo
                if (song.tone) {
                    document.querySelector('.tone').textContent = `Tone: ${song.tone}`;
                }
                if (song.capo !== undefined) {
                    document.querySelector('.capo').textContent = `Capo: ${song.capo}`;
                }
                
                // Cập nhật nội dung bài hát nếu cần
                if (song.chordSheet) {
                    document.querySelector('.chord-sheet').innerHTML = formatChordSheet(song.chordSheet);
                }
                if (song.kalimbaTab) {
                    document.querySelector('.kalimba-tab pre').textContent = song.kalimbaTab;
                }
                if (song.lyrics) {
                    document.querySelector('.lyrics').innerHTML = formatLyrics(song.lyrics);
                }
                
                // Lưu vào lượt xem gần đây
                saveRecentView(songId);
                
                // Kiểm tra trạng thái yêu thích
                const isFavorite = await checkFavoriteStatus(songId);
                updateFavoriteButton(isFavorite);
                
                // Thiết lập các chức năng tương tác
                setupInteractions(songId);
                
            } catch (error) {
                console.error('Lỗi khi tải chi tiết bài hát:', error);
                document.querySelector('.song-content').innerHTML = 
                    '<div class="error-message">Đã xảy ra lỗi khi tải thông tin bài hát. <a href="songs.html">Quay lại danh sách</a></div>';
            }
        });
        
        // Định dạng hợp âm từ dữ liệu
        function formatChordSheet(chordSheet) {
            if (typeof chordSheet === 'string') {
                return chordSheet; // Nếu đã là HTML thì giữ nguyên
            } else if (Array.isArray(chordSheet)) {
                let html = '';
                
                // Xử lý intro nếu có
                if (chordSheet.intro) {
                    html += `<h3>Intro: ${chordSheet.intro}</h3>`;
                }
                
                // Xử lý các đoạn
                chordSheet.forEach(section => {
                    if (section.type === 'verse') {
                        html += '<div class="verse">';
                    } else if (section.type === 'chorus') {
                        html += '<div class="chorus">';
                    } else {
                        html += '<div class="section">';
                    }
                    
                    if (section.title) {
                        html += `<h4>${section.title}</h4>`;
                    }
                    
                    section.lines.forEach(line => {
                        html += '<div class="line">';
                        
                        if (typeof line === 'string') {
                            html += `<span class="lyric">${line}</span>`;
                        } else if (Array.isArray(line)) {
                            line.forEach(part => {
                                if (part.chord) {
                                    html += `<span class="chord">[${part.chord}]</span>`;
                                }
                                if (part.lyric) {
                                    html += `<span class="lyric">${part.lyric}</span>`;
                                }
                            });
                        }
                        
                        html += '</div>'; // Đóng .line
                    });
                    
                    html += '</div>'; // Đóng .verse hoặc .chorus
                });
                
                return html;
            }
            
            return '<p>Không có dữ liệu hợp âm</p>';
        }
        
        // Định dạng lời bài hát
        function formatLyrics(lyrics) {
            if (typeof lyrics === 'string') {
                // Chuyển đổi xuống dòng thành thẻ <br>
                return lyrics.split('\n').map(line => {
                    return line.trim() ? line : '<br>';
                }).join('<br>');
            } else if (Array.isArray(lyrics)) {
                return lyrics.map(verse => {
                    return `<p>${verse.join('<br>')}</p>`;
                }).join('');
            }
            
            return '<p>Không có lời bài hát</p>';
        }
        
        // Cập nhật nút yêu thích theo trạng thái
        function updateFavoriteButton(isFavorite) {
            const favoriteBtn = document.querySelector('.favorite-btn i');
            if (isFavorite) {
                favoriteBtn.classList.remove('far');
                favoriteBtn.classList.add('fas');
            } else {
                favoriteBtn.classList.remove('fas');
                favoriteBtn.classList.add('far');
            }
        }
        
        // Thiết lập các tương tác
        function setupInteractions(songId) {
            // Xử lý chuyển tab
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = [
                document.querySelector('.chord-sheet'),
                document.querySelector('.kalimba-tab'),
                document.querySelector('.lyrics-only')
            ];
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // Ẩn tất cả tab
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Hiển thị tab được chọn
                    tabContents[index].style.display = 'block';
                    button.classList.add('active');
                });
            });
            
            // Xử lý nút yêu thích
            const favoriteBtn = document.querySelector('.favorite-btn');
            favoriteBtn.addEventListener('click', async () => {
                try {
                    const isFavorite = await toggleFavoriteSong(songId);
                    updateFavoriteButton(isFavorite);
                } catch (error) {
                    console.error('Lỗi khi thay đổi trạng thái yêu thích:', error);
                }
            });
            
            // Xử lý nút quay lại
            const backBtn = document.querySelector('.back-btn');
            backBtn.addEventListener('click', () => {
                window.history.back();
            });
            
            // Xử lý các nút chuyển tone (placeholder - cần bổ sung logic thực tế)
            const toneUpBtn = document.querySelector('.tone-up');
            const toneDownBtn = document.querySelector('.tone-down');
            const transposeBtn = document.querySelector('.transpose');
            
            toneUpBtn.addEventListener('click', () => {
                alert('Tính năng đang phát triển');
            });
            
            toneDownBtn.addEventListener('click', () => {
                alert('Tính năng đang phát triển');
            });
            
            transposeBtn.addEventListener('click', () => {
                alert('Tính năng đang phát triển');
            });
        }
    </script>
</body>
</html> 