<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalimba Chill - Hợp âm và Tab nhạc đàn Kalimba</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/google-auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/logo.jpeg" type="image/jpeg">
    
    <!-- Script để xóa bộ nhớ cache -->
    <script src="js/clear-cache.js"></script>
    <script src="js/auth-watchdog.js"></script>
    <script src="js/auth-login-helper.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/admin-auth.js"></script>
    
    <!-- Script vô hiệu hóa Firebase Auth UI -->
    <script src="js/disable-firebase-auth-ui.js"></script>
    
    <!-- Firebase SDK - Chỉ cần Firestore và Analytics -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- Firebase client script -->
    <script src="js/firebase-client.js"></script>
    
    <!-- Thông báo lỗi API key -->
    <script>
        // Hiển thị thông báo trợ giúp nếu đã có lỗi API key trước đó
        document.addEventListener('DOMContentLoaded', function() {
            const lastError = localStorage.getItem('last_auth_error');
            if (lastError) {
                try {
                    const errorObj = JSON.parse(lastError);
                    if (errorObj && errorObj.code && errorObj.code.includes('api-key-not-valid')) {
                        // Tạo thông báo trợ giúp
                        setTimeout(function() {
                            const helpMessage = document.createElement('div');
                            helpMessage.style.cssText = `
                                position: fixed;
                                top: 10px;
                                left: 50%;
                                transform: translateX(-50%);
                                background-color: #f8d7da;
                                color: #721c24;
                                padding: 10px 15px;
                                border-radius: 5px;
                                box-shadow: 0 0 10px rgba(0,0,0,0.2);
                                z-index: 9999;
                                max-width: 500px;
                                text-align: center;
                                font-size: 14px;
                            `;
                            
                            helpMessage.innerHTML = `
                                <strong>Lỗi kết nối:</strong> API key không hợp lệ<br>
                                <span style="font-size: 12px">Nhấn <strong>Ctrl+Shift+F</strong> để mở bảng điều khiển debug và cập nhật API key</span>
                                <button style="margin-left: 10px; padding: 2px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    Đóng
                                </button>
                            `;
                            
                            const closeBtn = helpMessage.querySelector('button');
                            closeBtn.addEventListener('click', function() {
                                helpMessage.remove();
                            });
                            
                            document.body.appendChild(helpMessage);
                        }, 1000);
                    }
                } catch (e) {
                    console.error('Lỗi khi phân tích lỗi trước đó:', e);
                }
            }
        });
    </script>
    
    <!-- Scripts tùy chỉnh -->
    <script src="js/script.js"></script>
</head>
<body>
    <div class="container">
        <!-- Mobile Header -->
        <header class="mobile-header">
            <div class="header-left">
                <button class="menu-btn" id="menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div class="header-center">
                <h1>
                    <img src="images/kalimba-chill-logo.jpg" alt="Kalimba Chill Logo" class="mobile-logo">
                    <span class="logo-text"><span class="highlight">Kalimba</span> Chill</span>
                </h1>
            </div>
            <div class="header-right">
                <div class="header-avatar">
                    <!-- User avatar sẽ được thêm tự động vào đây bởi javascript -->
                </div>
                <button class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
            </div>
        </header>

        <!-- Desktop Header -->
        <header class="desktop-header">
            <div class="container">
                <div class="logo">
                    <a href="index.html">
                        <img src="images/kalimba-chill-logo.jpg" alt="Kalimba Chill Logo" class="desktop-logo">
                        <span class="logo-text"><span class="highlight">Kalimba</span> Chill</span>
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="active"><i class="fas fa-home"></i> Trang chủ</a></li>
                        <li><a href="#donate"><i class="fas fa-hand-holding-heart"></i> Đóng góp</a></li>
                        <li><a href="feedback.html"><i class="fas fa-comment-dots"></i> Góp ý</a></li>
                    </ul>
                </nav>
                <div class="header-right">
                    <button class="login-with-google-btn" id="main-login-btn">
                        <i class="fab fa-google"></i> Đăng nhập
                    </button>
                    <div class="header-avatar" id="header-avatar">
                        <!-- User avatar sẽ được thêm tự động vào đây bởi javascript -->
                    </div>
                    <div class="user-menu" id="user-menu">
                        <div class="user-menu-header">
                            <div class="user-avatar"></div>
                            <div class="user-name">Chưa đăng nhập</div>
                            <div class="user-email"></div>
                        </div>
                        <div class="user-menu-items">
                            <a href="profile.html" class="user-menu-item user-only-menu-item">
                                <i class="fas fa-user"></i> Trang cá nhân
                            </a>
                            <a href="favorites.html" class="user-menu-item user-only-menu-item">
                                <i class="fas fa-heart"></i> Bài hát yêu thích
                            </a>
                            <a href="#" class="user-menu-item">
                                <i class="fas fa-list"></i> Playlist của tôi
                            </a>
                            <a href="recently-viewed.html" class="user-menu-item">
                                <i class="fas fa-history"></i> Đã xem gần đây
                            </a>
                            <a href="#" class="user-menu-item logout">
                                <i class="fas fa-sign-out-alt"></i> Đăng xuất
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Hero Search Section -->
        <section class="hero-search">
            <div class="search-container">
                <h2>Tìm hợp âm & tab nhạc đàn Kalimba cho bài hát yêu thích</h2>
                <div class="search-box">
                    <input type="text" placeholder="Nhập tên bài hát, ca sĩ hoặc lời bài hát...">
                    <button><i class="fas fa-search"></i></button>
                </div>
            </div>
        </section>

        <!-- Image Slider -->
        <section class="image-slider">
            <div class="slider-container">
                <div class="slider-wrapper" id="slider-wrapper">
                    <div class="slide">
                        <img src="images/slider1.jpg" alt="Kalimba 1">
                        <div class="slide-content">
                            <!-- Nội dung đã được xóa để tối ưu trên mobile -->
                        </div>
                    </div>
                    <div class="slide">
                        <img src="images/slider2.jpg" alt="Kalimba 2">
                        <div class="slide-content">
                            <!-- Nội dung đã được xóa để tối ưu trên mobile -->
                        </div>
                    </div>
                    <div class="slide">
                        <img src="images/slider3.jpg" alt="Kalimba 3">
                        <div class="slide-content">
                            <!-- Nội dung đã được xóa để tối ưu trên mobile -->
                        </div>
                    </div>
                    <div class="slide">
                        <img src="images/slider4.jpg" alt="Kalimba 4">
                        <div class="slide-content">
                            <!-- Nội dung đã được xóa để tối ưu trên mobile -->
                        </div>
                    </div>
                    <div class="slide">
                        <img src="images/slider5.jpg" alt="Kalimba 5">
                        <div class="slide-content">
                            <h3>Khóa học trực tuyến</h3>
                            <p>Đăng ký khóa học Kalimba trực tuyến cùng giảng viên</p>
                        </div>
                    </div>
                </div>
                <div class="slider-controls">
                    <button class="prev-btn"><i class="fas fa-chevron-left"></i></button>
                    <div class="slider-dots">
                        <span class="dot active" data-index="0"></span>
                        <span class="dot" data-index="1"></span>
                        <span class="dot" data-index="2"></span>
                        <span class="dot" data-index="3"></span>
                        <span class="dot" data-index="4"></span>
                    </div>
                    <button class="next-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </section>

        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-btn active"><i class="fas fa-fire"></i> Phổ biến</button>
            <button class="tab-btn"><i class="fas fa-history"></i> Xem gần đây</button>
            <button class="tab-btn"><i class="fas fa-heart"></i> Yêu thích</button>
        </nav>

        <main>
            <h2 class="section-title">Danh mục hợp âm và tab</h2>
            <div class="categories">
                <div class="category-item" data-category="de-choi">
                    <div class="category-image" style="background-color: #e9c46a;">
                        <h2>NGƯỜI MỚI TẬP CHƠI</h2>
                    </div>
                    <div class="category-title">Người mới tập chơi</div>
                </div>
                
                <div class="category-item" data-category="nhac-hot">
                    <div class="category-image" style="background-color: #e74c3c;">
                        <h2>Nhạc HOT</h2>
                    </div>
                    <div class="category-title">Nhạc HOT</div>
                </div>
                
                <div class="category-item" data-category="nhac-viet">
                    <div class="category-image" style="background-color: #27ae60;">
                        <h2>NHẠC VIỆT</h2>
                    </div>
                    <div class="category-title">Nhạc Việt</div>
                </div>
                
                <div class="category-item" data-category="nhac-bolero">
                    <div class="category-image" style="background-color: #9b59b6;">
                        <h2>NHẠC BOLERO</h2>
                    </div>
                    <div class="category-title">Nhạc Bolero</div>
                </div>
                
                <div class="category-item" data-category="nhac-hoa">
                    <div class="category-image" style="background-color: #d35400;">
                        <h2>NHẠC HOA</h2>
                    </div>
                    <div class="category-title">Nhạc Hoa</div>
                </div>
                
                <div class="category-item" data-category="nhac-us-uk">
                    <div class="category-image" style="background-color: #3498db;">
                        <h2>NHẠC US-UK</h2>
                    </div>
                    <div class="category-title">Nhạc US-UK</div>
                </div>
            </div>
        </main>

        <!-- Donate Section -->
        <section class="donate-section" id="donate">
            <div class="section-header">
                <h2 class="section-title">Ủng hộ phát triển Kalimba Chill</h2>
                <p>Đóng góp của bạn sẽ giúp chúng tôi duy trì và phát triển nhiều nội dung chất lượng hơn.</p>
            </div>
            
            <div class="donate-reason-compact">
                <h2>Vì sao cần ủng hộ Kalimba Chill?</h2>
                <ul>
                    <li><i class="fas fa-check-circle"></i> Duy trì máy chủ và chi phí vận hành website</li>
                    <li><i class="fas fa-check-circle"></i> Phát triển thêm tab và hợp âm cho nhiều bài hát mới</li>
                    <li><i class="fas fa-check-circle"></i> Cải thiện giao diện và trải nghiệm người dùng</li>
                    <li><i class="fas fa-check-circle"></i> Xây dựng ứng dụng di động trong tương lai</li>
                </ul>
                <button id="show-donate-details" class="btn donate-btn">
                    <i class="fas fa-hand-holding-heart"></i> Quyên góp ngay
                </button>
            </div>
            
            <div class="donate-content" style="display: none;">
                <div class="donate-left">
                    <div class="author-image">
                        <img src="images/author.jpg" alt="Tác giả Kalimba Chill">
                        <h3>Người sáng lập Kalimba Chill</h3>
                        <p>Chúng tôi luôn cố gắng mang đến cho bạn những trải nghiệm tốt nhất với đàn Kalimba</p>
                    </div>
                    
                    <div class="donate-reason">
                        <h2>Vì sao cần ủng hộ Kalimba Chill?</h2>
                        <ul>
                            <li><i class="fas fa-check-circle"></i> Duy trì máy chủ và chi phí vận hành website</li>
                            <li><i class="fas fa-check-circle"></i> Phát triển thêm tab và hợp âm cho nhiều bài hát mới</li>
                            <li><i class="fas fa-check-circle"></i> Cải thiện giao diện và trải nghiệm người dùng</li>
                            <li><i class="fas fa-check-circle"></i> Xây dựng ứng dụng di động trong tương lai</li>
                        </ul>
                        <p>Mọi sự đóng góp, dù nhỏ hay lớn, đều có ý nghĩa đối với chúng tôi!</p>
                    </div>
                </div>
                
                <div class="donate-right">
                    <div class="donate-info">
                        <h2>Thông tin tài khoản</h2>
                        
                        <div class="qr-code">
                            <img src="images/qr-code.jpg" alt="Mã QR thanh toán">
                            <p>Quét mã QR để chuyển khoản nhanh</p>
                        </div>
                        
                        <div class="bank-info">
                            <div class="info-item">
                                <span class="info-label">Số tài khoản:</span>
                                <span class="info-value">6910694932</span>
                                <div class="copy-btn-container">
                                    <button class="copy-btn" data-copy="6910694932">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">Ngân hàng:</span>
                                <span class="info-value">BIDV</span>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">Chủ tài khoản:</span>
                                <span class="info-value">LE HAI DANG</span>
                            </div>
                            
                            <div class="info-item momo-item">
                                <span class="info-label"><i class="fas fa-wallet momo-icon"></i> Momo:</span>
                                <span class="info-value">0793776157</span>
                                <div class="copy-btn-container">
                                    <button class="copy-btn" data-copy="0793776157">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="thank-you-message">
                        <h3><i class="fas fa-heart"></i> Chân thành cảm ơn sự ủng hộ của bạn!</h3>
                        <p>Mọi đóng góp đều được ghi nhận và dùng để phát triển cộng đồng Kalimba Việt Nam.</p>
                    </div>
                    
                    <button id="hide-donate-details" class="btn donate-btn-close">
                        <i class="fas fa-times"></i> Đóng
                    </button>
                </div>
            </div>
            
            <div class="donate-message" style="display: none;">
                <!-- Đã di chuyển nội dung này sang phần bên trái -->
            </div>
        </section>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="footer-content">
                <div class="footer-logo">
                    <div class="footer-logo-img">
                        <img src="images/kalimba-chill-logo.jpg" alt="Kalimba Chill Logo" class="footer-logo-image">
                    </div>
                    <h2>Kalimba Chill</h2>
                    <p>Website hợp âm và tab nhạc đàn Kalimba hàng đầu Việt Nam</p>
                </div>
                <div class="footer-links">
                    <h3>Liên kết</h3>
                    <ul>
                        <li><a href="#">Trang chủ</a></li>
                        <li><a href="#">Danh sách bài hát</a></li>
                        <li><a href="#">Khóa học</a></li>
                        <li><a href="#donate">Đóng góp</a></li>
                        <li><a href="feedback.html">Góp ý</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h3>Liên hệ</h3>
                    <p><i class="fas fa-envelope"></i> info@kalimbachill.com</p>
                    <p><i class="fas fa-phone"></i> +84 123 456 789</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-tiktok"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 Kalimba Chill. Tất cả các quyền được bảo lưu.</p>
            </div>
        </footer>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fab fa-google"></i>
                    </div>
                    <div class="login-section">
                        <button class="login-with-google-btn">
                            <i class="fab fa-google"></i> Đăng nhập
                        </button>
                    </div>
                </div>
            </div>
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#" class="active"><i class="fas fa-home"></i> Trang chủ</a></li>
                    <li><a href="#"><i class="fas fa-music"></i> Bài hát</a></li>
                    <li><a href="#"><i class="fas fa-book"></i> Khóa học</a></li>
                    <li><a href="#"><i class="fas fa-list"></i> Playlist của tôi</a></li>
                    <li><a href="favorites.html"><i class="fas fa-heart"></i> Yêu thích</a></li>
                    <li><a href="#"><i class="fas fa-search"></i> Tìm theo hợp âm</a></li>
                    <li><a href="#"><i class="fas fa-guitar"></i> Tra cứu hợp âm</a></li>
                    <li><a href="#donate"><i class="fas fa-hand-holding-heart"></i> Đóng góp</a></li>
                    <li><a href="feedback.html"><i class="fas fa-comment-dots"></i> Góp ý</a></li>
                    <li><a href="#"><i class="fas fa-cog"></i> Thiết lập</a></li>
                </ul>
            </nav>
        </div>
        <div class="overlay" id="overlay"></div>
    </div>
    
    <script>
        // Copy to clipboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const textToCopy = this.getAttribute('data-copy');
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        // Change icon temporarily to show success
                        const icon = this.querySelector('i');
                        icon.classList.remove('fa-copy');
                        icon.classList.add('fa-check');
                        
                        setTimeout(() => {
                            icon.classList.remove('fa-check');
                            icon.classList.add('fa-copy');
                        }, 2000);
                    });
                });
            });
            
            // Xử lý sự kiện hiển thị/ẩn phần chi tiết đóng góp
            const showDonateBtn = document.getElementById('show-donate-details');
            const hideDonateBtn = document.getElementById('hide-donate-details');
            const donateContent = document.querySelector('.donate-content');
            const donateReasonCompact = document.querySelector('.donate-reason-compact');
            
            if (showDonateBtn && donateContent && donateReasonCompact) {
                showDonateBtn.addEventListener('click', function() {
                    donateContent.style.display = 'flex';
                    donateReasonCompact.style.display = 'none';
                    
                    // Cuộn đến phần đóng góp
                    const donateSection = document.getElementById('donate');
                    if (donateSection) {
                        donateSection.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }
            
            if (hideDonateBtn && donateContent && donateReasonCompact) {
                hideDonateBtn.addEventListener('click', function() {
                    donateContent.style.display = 'none';
                    donateReasonCompact.style.display = 'block';
                });
            }
            
            // Khởi tạo Firebase
            if (window.KalimbaFirebase) {
                KalimbaFirebase.init().then(() => {
                    console.log('Firebase đã được khởi tạo');
                }).catch(error => {
                    console.error('Lỗi khi khởi tạo Firebase:', error);
                });
            }
        });
    </script>
    
    <!-- Google Auth Integration -->
    <script src="js/google-auth.js"></script>
    <script src="js/firestore-operations.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Thiết lập tương tác với các phần tử trên trang
            setupInteractions();
            
            // Khởi tạo sự kiện đăng nhập nếu chưa được khởi tạo tự động
            if (typeof attachLoginEvents === 'function') {
                attachLoginEvents();
            } else {
                // Đợi nếu Google Auth script chưa được tải
                setTimeout(function() {
                    if (typeof attachLoginEvents === 'function') {
                        attachLoginEvents();
                    }
                }, 1000);
            }
        });
        
        // Thiết lập tương tác
        function setupInteractions() {
            // Nút menu cho mobile
            const menuBtn = document.getElementById('menu-btn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (menuBtn && sidebar && overlay) {
                console.log('Thiết lập sự kiện click cho menu button');
                menuBtn.addEventListener('click', function(event) {
                    console.log('Menu button clicked');
                    event.preventDefault(); // Ngăn chặn các hành vi mặc định
                    event.stopPropagation(); // Ngăn chặn sự kiện lan lên
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                    // Cập nhật avatar trong sidebar khi mở sidebar
                    updateSidebarAvatar();
                });
                
                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            } else {
                console.error('Không tìm thấy các phần tử menu cần thiết', {
                    menuBtn: menuBtn, 
                    sidebar: sidebar, 
                    overlay: overlay
                });
            }
        }
        
        // Cập nhật avatar trong sidebar
        function updateSidebarAvatar() {
            try {
                // Lấy thông tin người dùng từ localStorage
                const userDataStr = localStorage.getItem('userData');
                if (userDataStr) {
                    const userData = JSON.parse(userDataStr);
                    
                    // Tìm avatar và login section trong sidebar
                    const sidebarAvatar = document.querySelector('.sidebar .user-avatar');
                    const loginSection = document.querySelector('.sidebar .login-section');
                    
                    if (sidebarAvatar && loginSection) {
                        // Xóa nội dung cũ
                        sidebarAvatar.innerHTML = '';
                        
                        // Hiển thị avatar người dùng
                        if (userData.picture) {
                            const avatar = document.createElement('img');
                            avatar.src = userData.picture;
                            avatar.alt = userData.name;
                            avatar.className = 'avatar-img';
                            sidebarAvatar.appendChild(avatar);
                        } else {
                            // Nếu không có ảnh, hiển thị chữ cái đầu của tên người dùng
                            const initial = document.createElement('div');
                            initial.className = 'avatar-initial';
                            initial.textContent = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
                            sidebarAvatar.appendChild(initial);
                        }
                        
                        // Ẩn section đăng nhập
                        loginSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật avatar sidebar:', error);
            }
        }
    </script>
    
    <!-- Script ẩn thông báo lỗi quyền -->
    <script>
      // Hàm ẩn thông báo lỗi quyền
      function hidePermissionErrors() {
        // Tìm tất cả thông báo lỗi (dựa vào màu và nội dung)
        const errorElements = document.querySelectorAll('div[style*="background-color: #f8d7da"], .firebase-error-message, .error-message');
        
        errorElements.forEach(element => {
          // Kiểm tra nội dung
          const content = element.textContent || '';
          if (content.includes('không có quyền') || 
              content.includes('đăng nhập lại') || 
              content.includes('permission') ||
              content.includes('Bạn không có quyền')) {
            // Ẩn ngay lập tức
            element.style.display = 'none';
            
            // Xóa khỏi DOM
            setTimeout(() => {
              if (element.parentNode) {
                element.parentNode.removeChild(element);
              }
            }, 100);
          }
        });
      }

      // Thực thi ngay khi script được tải
      hidePermissionErrors();
      
      // Thiết lập thực thi định kỳ
      setInterval(hidePermissionErrors, 500);
    </script>
    
    <!-- Script xử lý tình trạng đăng nhập -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Ẩn Firebase Auth UI
        const firebaseAuthContainer = document.querySelector('.firebaseui-container');
        if (firebaseAuthContainer) {
          firebaseAuthContainer.style.display = 'none';
        }
        
        // Kiểm tra nếu người dùng đã đăng nhập
        const savedUser = localStorage.getItem('kalimbaUser');
        if (savedUser) {
          // Ẩn tất cả các nút đăng nhập Google
          document.querySelectorAll('.login-with-google-btn').forEach(btn => {
            btn.style.display = 'none';
          });
          
          // Hiển thị avatar đăng nhập
          const headerAvatar = document.getElementById('header-avatar');
          if (headerAvatar) {
            headerAvatar.style.display = 'block';
            headerAvatar.classList.add('logged-in');
          }
          
          // Hiển thị các mục menu chỉ dành cho người dùng đã đăng nhập
          document.querySelectorAll('.user-only-menu-item').forEach(item => {
            item.style.display = 'flex';
          });
        }
        
        // Ngăn chặn Firebase Authentication tự động hiển thị
        if (window.firebase && window.firebase.auth) {
          // Tắt UI tự động của Firebase Auth
          const firebaseUIElements = document.querySelectorAll('.firebaseui-auth-container');
          firebaseUIElements.forEach(el => {
            el.style.display = 'none';
          });
        }
      });
    </script>

    <!-- Thêm user-menu và overlay cho menu này -->
    <div class="user-menu-overlay" style="display: none;"></div>
    <div id="mobile-user-menu" class="user-menu">
        <div class="user-menu-header">
            <div class="user-avatar"></div>
            <div class="user-info">
                <div class="user-name">Chưa đăng nhập</div>
                <div class="user-email"></div>
            </div>
        </div>
        <div class="user-menu-items">
            <a href="favorites.html" class="user-menu-item menu-close">
                <i class="fas fa-heart"></i> Bài hát yêu thích
            </a>
            <a href="#" class="user-menu-item menu-close">
                <i class="fas fa-list"></i> Playlist của tôi
            </a>
            <a href="recently-viewed.html" class="user-menu-item menu-close">
                <i class="fas fa-history"></i> Đã xem gần đây
            </a>
            <a href="#" class="user-menu-item logout menu-close">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </a>
            <button class="btn close-menu-btn menu-close">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Trang index.html được tải, bắt đầu tải dữ liệu bài hát');
                
                // Chờ Firebase được khởi tạo
                await waitForFirebase();
                
                // Hiển thị loading trên tất cả các section
                document.querySelectorAll('.loading-container').forEach(container => {
                    container.style.display = 'flex';
                });
                
                // Tải song song các danh mục bài hát
                const categories = ['nhac-hot', 'nhac-hoa', 'nhac-us-uk'];
                
                // Đảm bảo Firestore đã được khởi tạo
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase không được định nghĩa');
                }
                
                if (!firebase.firestore) {
                    throw new Error('Firestore không khả dụng');
                }
                
                // Tạo một mảng các promise để tải nhiều danh mục song song
                const promises = categories.map(category => {
                    return loadSongsForCategory(category);
                });
                
                // Chờ tất cả các danh mục tải xong
                await Promise.allSettled(promises);
                
                console.log('Đã tải xong các danh mục bài hát');
            } catch (error) {
                console.error('Lỗi khi tải trang chủ:', error);
                
                // Hiển thị thông báo lỗi
                document.querySelectorAll('.loading-container').forEach(container => {
                    container.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Đã xảy ra lỗi: ${error.message || 'Không thể kết nối đến cơ sở dữ liệu'}</span>
                        </div>
                    `;
                });
            }
        });
        
        // Hàm tải bài hát cho một danh mục cụ thể
        async function loadSongsForCategory(category) {
            try {
                console.log(`Bắt đầu tải bài hát cho danh mục ${category}`);
                
                const containerId = `${category}-songs-container`;
                const sectionId = `${category}-songs`;
                const loadingContainer = document.querySelector(`#${sectionId} .loading-container`);
                const songsContainer = document.getElementById(containerId);
                
                if (!songsContainer) {
                    console.warn(`Không tìm thấy container với ID ${containerId}`);
                    return;
                }
                
                // Truy vấn trực tiếp từ Firestore
                const songsRef = firebase.firestore().collection('songs');
                const query = songsRef.where('category', '==', category).limit(6);
                
                // Thực hiện truy vấn
                const snapshot = await query.get();
                
                // Ẩn loading
                if (loadingContainer) {
                    loadingContainer.style.display = 'none';
                }
                
                if (snapshot.empty) {
                    console.log(`Không tìm thấy bài hát nào cho danh mục ${category}`);
                    songsContainer.innerHTML = `<p class="no-songs">Không có bài hát nào trong danh mục này.</p>`;
                    return;
                }
                
                console.log(`Đã tìm thấy ${snapshot.size} bài hát cho danh mục ${category}`);
                
                // Lấy danh sách yêu thích để kiểm tra trạng thái
                let favorites = [];
                try {
                    const favoritesJson = localStorage.getItem('kalimbaFavorites');
                    if (favoritesJson) {
                        favorites = JSON.parse(favoritesJson);
                    }
                } catch (e) {
                    console.error('Lỗi khi đọc danh sách yêu thích:', e);
                }
                
                // Tạo HTML cho bài hát
                let songsHTML = '';
                
                snapshot.forEach(doc => {
                    const song = {
                        id: doc.id,
                        ...doc.data()
                    };
                    
                    const isFavorite = favorites.includes(song.id);
                    
                    songsHTML += `
                        <div class="featured-song-item">
                            <div class="song-thumb">
                                <img src="${song.thumbnail || 'images/default-song.jpg'}" alt="${song.title || 'Bài hát'}" onerror="this.src='images/default-song.jpg'">
                                <div class="play-icon">
                                    <i class="fas fa-music"></i>
                                </div>
                            </div>
                            <div class="song-info">
                                <h3>${song.title || 'Không có tiêu đề'}</h3>
                                <p>${song.artist || 'Không có nghệ sĩ'}</p>
                            </div>
                            <a href="song-detail.html?id=${song.id}" class="song-link"></a>
                        </div>
                    `;
                });
                
                // Cập nhật HTML và hiển thị
                songsContainer.innerHTML = songsHTML;
                songsContainer.style.display = 'grid';
                
                console.log(`Hoàn tất hiển thị bài hát cho danh mục ${category}`);
            } catch (error) {
                console.error(`Lỗi khi tải bài hát cho danh mục ${category}:`, error);
                
                const sectionId = `${category}-songs`;
                const loadingContainer = document.querySelector(`#${sectionId} .loading-container`);
                
                if (loadingContainer) {
                    loadingContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Đã xảy ra lỗi khi tải bài hát: ${error.message}</span>
                        </div>
                    `;
                }
            }
        }
        
        // Chờ Firebase được khởi tạo
        function waitForFirebase(timeout = 10000) {
            return new Promise((resolve, reject) => {
                const start = Date.now();
                
                const checkFirebase = () => {
                    if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                        console.log('Firebase đã được khởi tạo');
                        resolve();
                        return;
                    }
                    
                    if (Date.now() - start > timeout) {
                        console.error('Timeout khi chờ Firebase khởi tạo');
                        reject(new Error('Timeout khi chờ Firebase khởi tạo'));
                        return;
                    }
                    
                    console.log('Đang chờ Firebase khởi tạo...');
                    setTimeout(checkFirebase, 500);
                };
                
                checkFirebase();
            });
        }
    </script>

    <!-- Script khắc phục vấn đề nút menu và user-profile -->
    <script>
        (function() {
            console.log("Đang khắc phục vấn đề nút menu và user-profile trên trang chủ...");
            
            // Khắc phục nút menu
            function fixMenuButton() {
                try {
                    // Lấy các phần tử cần thiết
                    const menuBtn = document.getElementById('menu-btn');
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    
                    if (!menuBtn || !sidebar || !overlay) {
                        console.error("Không tìm thấy một hoặc nhiều phần tử cần thiết:", {
                            menuBtn: !!menuBtn,
                            sidebar: !!sidebar,
                            overlay: !!overlay
                        });
                        return;
                    }
                    
                    console.log("Đã tìm thấy tất cả các phần tử cần thiết, đang thiết lập lại nút menu...");
                    
                    // Tạo bản sao mới của nút menu để loại bỏ tất cả event listener hiện tại
                    const newMenuBtn = menuBtn.cloneNode(true);
                    menuBtn.parentNode.replaceChild(newMenuBtn, menuBtn);
                    
                    // Thêm event handler mới
                    newMenuBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log("Nút menu được nhấp, đang mở sidebar...");
                        
                        // Mở sidebar và overlay
                        sidebar.classList.add('active');
                        overlay.classList.add('active');
                        
                        // Cập nhật avatar trong sidebar
                        updateSidebarAvatar();
                        
                        return false;
                    };
                    
                    // Đảm bảo overlay đóng sidebar khi được nhấp
                    overlay.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log("Overlay được nhấp, đang đóng sidebar...");
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                        return false;
                    });
                    
                    console.log("Đã thiết lập thành công nút menu và overlay");
                } catch (error) {
                    console.error("Lỗi khi thiết lập lại nút menu:", error);
                }
            }
            
            // Cập nhật avatar và thông tin người dùng trong sidebar
            function updateSidebarAvatar() {
                try {
                    console.log("Đang cập nhật thông tin người dùng trong sidebar...");
                    
                    // Tìm kiếm dữ liệu người dùng từ nhiều nguồn khác nhau
                    let userData = null;
                    let userDataSource = '';
                    
                    // Kiểm tra từ 'kalimbaUser' (được sử dụng trong nhiều phần của ứng dụng)
                    const kalimbaUserData = localStorage.getItem('kalimbaUser');
                    if (kalimbaUserData) {
                        try {
                            userData = JSON.parse(kalimbaUserData);
                            userDataSource = 'kalimbaUser';
                            console.log("Đã tìm thấy dữ liệu người dùng từ 'kalimbaUser'");
                        } catch (e) {
                            console.warn("Lỗi khi parse dữ liệu từ 'kalimbaUser':", e);
                        }
                    }
                    
                    // Nếu không tìm thấy, kiểm tra từ 'userData'
                    if (!userData) {
                        const userDataStr = localStorage.getItem('userData');
                        if (userDataStr) {
                            try {
                                userData = JSON.parse(userDataStr);
                                userDataSource = 'userData';
                                console.log("Đã tìm thấy dữ liệu người dùng từ 'userData'");
                            } catch (e) {
                                console.warn("Lỗi khi parse dữ liệu từ 'userData':", e);
                            }
                        }
                    }
                    
                    // Nếu vẫn không tìm thấy, kiểm tra từ firebase.auth().currentUser
                    if (!userData && typeof firebase !== 'undefined' && firebase.auth) {
                        const currentUser = firebase.auth().currentUser;
                        if (currentUser) {
                            userData = {
                                name: currentUser.displayName,
                                email: currentUser.email,
                                picture: currentUser.photoURL
                            };
                            userDataSource = 'firebase.currentUser';
                            console.log("Đã tìm thấy dữ liệu người dùng từ Firebase Auth");
                        }
                    }
                    
                    // Tìm avatar và login section trong sidebar
                    const sidebarAvatar = document.querySelector('.sidebar .user-avatar');
                    const loginSection = document.querySelector('.sidebar .login-section') || document.querySelector('.sidebar .login-with-google-btn');
                    const userProfile = document.querySelector('.sidebar .user-profile');
                    
                    if (!sidebarAvatar) {
                        console.error("Không tìm thấy phần tử sidebar avatar");
                        return;
                    }
                    
                    // Nếu có dữ liệu người dùng
                    if (userData && (userData.picture || userData.name || userData.email)) {
                        console.log("Hiển thị thông tin người dùng...", userData);
                        
                        // Xóa nội dung cũ
                        sidebarAvatar.innerHTML = '';
                        
                        // Hiển thị avatar người dùng
                        if (userData.picture) {
                            const avatar = document.createElement('img');
                            avatar.src = userData.picture;
                            avatar.alt = userData.name || "User";
                            avatar.className = 'avatar-img';
                            avatar.style.width = "100%";
                            avatar.style.height = "100%";
                            avatar.style.objectFit = "cover";
                            avatar.style.borderRadius = "50%";
                            sidebarAvatar.appendChild(avatar);
                        } else {
                            // Nếu không có ảnh, hiển thị chữ cái đầu của tên người dùng
                            const initial = document.createElement('div');
                            initial.className = 'avatar-initial';
                            initial.textContent = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
                            initial.style.backgroundColor = "#4285f4";
                            initial.style.color = "white";
                            initial.style.width = "100%";
                            initial.style.height = "100%";
                            initial.style.display = "flex";
                            initial.style.alignItems = "center";
                            initial.style.justifyContent = "center";
                            initial.style.borderRadius = "50%";
                            initial.style.fontSize = "24px";
                            sidebarAvatar.appendChild(initial);
                        }
                        
                        // Ẩn nút đăng nhập nếu có
                        if (loginSection) {
                            if (loginSection.tagName === 'BUTTON') {
                                loginSection.style.display = 'none';
                            } else {
                                loginSection.style.display = 'none';
                            }
                        }
                        
                        // Hiển thị tên người dùng nếu chưa có
                        if (userData.name && userProfile) {
                            let userNameElement = userProfile.querySelector('.user-name');
                            if (!userNameElement) {
                                userNameElement = document.createElement('div');
                                userNameElement.className = 'user-name';
                                userProfile.appendChild(userNameElement);
                            }
                            userNameElement.textContent = userData.name;
                            userNameElement.style.margin = '10px 0 5px';
                            userNameElement.style.fontWeight = 'bold';
                            userNameElement.style.textAlign = 'center';
                        }
                        
                        // Hiển thị email người dùng nếu có
                        if (userData.email && userProfile) {
                            let userEmailElement = userProfile.querySelector('.user-email');
                            if (!userEmailElement) {
                                userEmailElement = document.createElement('div');
                                userEmailElement.className = 'user-email';
                                userProfile.appendChild(userEmailElement);
                            }
                            userEmailElement.textContent = userData.email;
                            userEmailElement.style.fontSize = '12px';
                            userEmailElement.style.color = '#666';
                            userEmailElement.style.textAlign = 'center';
                            userEmailElement.style.marginBottom = '10px';
                        }
                        
                        console.log("Đã cập nhật thành công thông tin người dùng từ nguồn:", userDataSource);
                    } else {
                        console.log("Không tìm thấy dữ liệu người dùng, hiển thị nút đăng nhập...");
                        
                        // Nếu không có dữ liệu người dùng, hiển thị lại nút đăng nhập
                        sidebarAvatar.innerHTML = '<i class="fab fa-google"></i>';
                        if (loginSection) {
                            if (loginSection.tagName === 'BUTTON') {
                                loginSection.style.display = 'block';
                            } else {
                                loginSection.style.display = 'block';
                            }
                        }
                        
                        // Xóa thông tin tên và email nếu đã hiển thị trước đó
                        if (userProfile) {
                            const userNameElement = userProfile.querySelector('.user-name');
                            const userEmailElement = userProfile.querySelector('.user-email');
                            
                            if (userNameElement) userNameElement.remove();
                            if (userEmailElement) userEmailElement.remove();
                        }
                    }
                } catch (error) {
                    console.error('Lỗi khi cập nhật thông tin người dùng trong sidebar:', error);
                }
            }
            
            // Gắn sự kiện vào nút đăng nhập trong sidebar
            function setupLoginButton() {
                try {
                    const loginButton = document.querySelector('.sidebar .login-with-google-btn');
                    if (loginButton) {
                        console.log("Đang thiết lập lại nút đăng nhập...");
                        
                        // Xóa tất cả các sự kiện hiện có
                        const newLoginButton = loginButton.cloneNode(true);
                        loginButton.parentNode.replaceChild(newLoginButton, loginButton);
                        
                        // Thêm sự kiện click mới
                        newLoginButton.addEventListener('click', function() {
                            console.log("Nút đăng nhập được nhấp, đang kích hoạt đăng nhập Google...");
                            
                            // Gọi hàm đăng nhập nếu có sẵn
                            if (typeof handleGoogleLogin === 'function') {
                                handleGoogleLogin();
                            } else if (typeof window.firebaseAuth && typeof window.firebaseAuth.signInWithGoogle === 'function') {
                                window.firebaseAuth.signInWithGoogle();
                            } else {
                                console.error("Không tìm thấy hàm đăng nhập Google");
                            }
                        });
                        
                        console.log("Đã thiết lập thành công nút đăng nhập");
                    }
                } catch (error) {
                    console.error("Lỗi khi thiết lập nút đăng nhập:", error);
                }
            }
            
            // Xử lý sự kiện click vào avatar để hiển thị menu
            function setupAvatarClickEvent() {
                try {
                    // Xử lý avatar trên desktop header
                    const desktopAvatar = document.getElementById('header-avatar');
                    const desktopUserMenu = document.getElementById('user-menu');
                    
                    if (desktopAvatar && desktopUserMenu) {
                        console.log("Thiết lập sự kiện click cho avatar desktop");
                        
                        // Xóa sự kiện hiện có
                        const newDesktopAvatar = desktopAvatar.cloneNode(true);
                        desktopAvatar.parentNode.replaceChild(newDesktopAvatar, desktopAvatar);
                        
                        // Thêm sự kiện click mới
                        newDesktopAvatar.addEventListener('click', function(e) {
                            e.stopPropagation();
                            console.log("Avatar desktop được nhấp");
                            
                            // Toggle menu
                            desktopUserMenu.classList.toggle('active');
                            
                            // Thêm sự kiện click bên ngoài để đóng menu
                            document.addEventListener('click', function closeDesktopMenu(event) {
                                if (!desktopUserMenu.contains(event.target) && !newDesktopAvatar.contains(event.target)) {
                                    desktopUserMenu.classList.remove('active');
                                    document.removeEventListener('click', closeDesktopMenu);
                                }
                            });
                        });
                    }
                    
                    // Xử lý avatar trên mobile
                    const mobileAvatar = document.querySelector('.mobile-header .header-avatar');
                    const mobileUserMenu = document.getElementById('mobile-user-menu');
                    const userMenuOverlay = document.querySelector('.user-menu-overlay');
                    
                    if (mobileAvatar && mobileUserMenu) {
                        console.log("Thiết lập sự kiện click cho avatar mobile");
                        
                        // Thêm class để chỉ rõ vùng có thể click
                        mobileAvatar.classList.add('clickable');
                        
                        // Thêm nút login vào sự kiện xử lý
                        const loginBtn = document.querySelector('.mobile-header .login-btn');
                        
                        // Xóa tất cả sự kiện hiện có
                        const newMobileAvatar = mobileAvatar.cloneNode(true);
                        mobileAvatar.parentNode.replaceChild(newMobileAvatar, mobileAvatar);
                        
                        // Thêm sự kiện click mới cho avatar
                        newMobileAvatar.addEventListener('click', showMobileUserMenu);
                        
                        // Nếu có nút login, gắn sự kiện click cho nó
                        if (loginBtn) {
                            const newLoginBtn = loginBtn.cloneNode(true);
                            loginBtn.parentNode.replaceChild(newLoginBtn, loginBtn);
                            newLoginBtn.addEventListener('click', showMobileUserMenu);
                        }
                        
                        // Thêm sự kiện đóng menu khi click vào các mục menu có class menu-close
                        const menuCloseItems = document.querySelectorAll('.menu-close');
                        menuCloseItems.forEach(item => {
                            item.addEventListener('click', function(e) {
                                // Không ngăn mặc định để cho phép liên kết hoạt động
                                
                                // Đóng menu
                                mobileUserMenu.classList.remove('visible');
                                if (userMenuOverlay) {
                                    userMenuOverlay.style.display = 'none';
                                }
                            });
                        });
                        
                        // Hàm xử lý hiển thị menu
                        function showMobileUserMenu(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log("Avatar/Login mobile được nhấp");
                            
                            // Hiển thị menu và overlay
                            mobileUserMenu.classList.add('visible');
                            if (userMenuOverlay) {
                                userMenuOverlay.style.display = 'block';
                                
                                // Đóng menu khi nhấp vào overlay
                                const closeMenu = function() {
                                    mobileUserMenu.classList.remove('visible');
                                    userMenuOverlay.style.display = 'none';
                                    // Xóa sự kiện để tránh đăng ký nhiều lần
                                    userMenuOverlay.removeEventListener('click', closeMenu);
                                };
                                
                                userMenuOverlay.addEventListener('click', closeMenu);
                            }
                            
                            return false;
                        }
                    }
                } catch (error) {
                    console.error("Lỗi khi thiết lập sự kiện click cho avatar:", error);
                }
            }
            
            // Thêm CSS để sửa menu người dùng
            function addFixedCSS() {
                const style = document.createElement('style');
                style.textContent = `
                    /* Sửa lỗi chồng chéo menu user */
                    #user-menu, #mobile-user-menu {
                        z-index: 1000;
                        position: absolute;
                        background-color: white;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        padding: 0;
                        overflow: hidden;
                        width: 220px;
                        transform: translateY(10px);
                        visibility: hidden;
                        opacity: 0;
                        transition: all 0.2s;
                    }
                    
                    #user-menu.active, #mobile-user-menu.visible {
                        transform: translateY(0);
                        visibility: visible;
                        opacity: 1;
                    }
                    
                    /* Menu desktop */
                    .desktop-header #user-menu {
                        right: 0;
                        top: 100%;
                    }
                    
                    /* Menu mobile */
                    #mobile-user-menu {
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) scale(0.9);
                        z-index: 2000;
                        width: 90%;
                        max-width: 280px;
                    }
                    
                    #mobile-user-menu.visible {
                        transform: translate(-50%, -50%) scale(1);
                    }
                    
                    /* Nút đóng trong menu mobile */
                    .close-menu-btn {
                        display: block;
                        width: 100%;
                        padding: 10px;
                        margin-top: 10px;
                        background-color: #f1f1f1;
                        color: #666;
                        border: none;
                        border-radius: 0;
                        text-align: center;
                        cursor: pointer;
                    }
                    
                    .close-menu-btn:hover, .close-menu-btn:active {
                        background-color: #e5e5e5;
                    }
                    
                    /* Overlay cho menu mobile */
                    .user-menu-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(0, 0, 0, 0.5);
                        z-index: 1999;
                    }
                    
                    /* Cải thiện vùng click cho avatar mobile */
                    .mobile-header .header-avatar {
                        cursor: pointer;
                        position: relative;
                    }
                    
                    .mobile-header .header-avatar.clickable::after {
                        content: '';
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        bottom: -8px;
                        left: -8px;
                        z-index: -1;
                    }
                    
                    .mobile-header .header-avatar:active {
                        opacity: 0.8;
                    }
                    
                    .mobile-header .login-btn {
                        cursor: pointer;
                    }
                `;
                document.head.appendChild(style);
                console.log("Đã thêm CSS để sửa menu người dùng");
            }
            
            // Thực hiện các khắc phục ngay lập tức
            fixMenuButton();
            updateSidebarAvatar();
            setupLoginButton();
            setupAvatarClickEvent();
            addFixedCSS();
            
            // Thực hiện lại sau khi DOM đã tải xong
            document.addEventListener('DOMContentLoaded', function() {
                fixMenuButton();
                updateSidebarAvatar();
                setupLoginButton();
                setupAvatarClickEvent();
            });
        })();
    </script>
</body>
</html> 