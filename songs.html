<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhạc Vàng Tuyển Chọn - Kalimba Chill</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/logo.jpeg" type="image/jpeg">
    
    <!-- Script để xóa bộ nhớ cache -->
    <script src="js/clear-cache.js"></script>
    <script src="js/auth-watchdog.js"></script>
    <script src="js/auth-login-helper.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/firebase-constants.js"></script>
    <script src="js/firebase-debug.js"></script>
    
    <!-- Firebase App (cần thiết cho tất cả các sản phẩm của Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    
    <!-- Thêm các SDK Firebase mà bạn muốn sử dụng -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Scripts tùy chỉnh -->
    <script src="js/firebase-auth.js"></script>
    <script src="js/firestore-operations.js"></script>
    <script src="js/script.js"></script>
</head>
<body>
    <div class="container">
        <header class="song-list-header">
            <div class="header-left">
                <button class="menu-btn" id="menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="back-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="header-center">
                <h1>
                    <img src="images/kalimba-chill-logo.jpg" alt="Kalimba Chill Logo" class="mobile-logo">
                    <span class="logo-text">Nhạc Vàng Tuyển Chọn</span>
                </h1>
            </div>
            <div class="header-right">
                <div class="header-avatar">
                    <!-- User avatar sẽ được thêm tự động vào đây bởi javascript -->
                </div>
                <button class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
            </div>
        </header>

        <main class="song-list">
            <div class="list-header">
                <h2>Danh mục bài hát</h2>
                <p>Tải dữ liệu từ Firebase</p>
            </div>
            
            <ul class="songs">
                <!-- Phần tử tải mặc định, sẽ được thay thế bằng dữ liệu thật từ Firebase -->
                <li class="loading-item">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Đang tải danh sách bài hát...</span>
                    </div>
                </li>
                
                <!-- Tin nhắn khi không có bài hát (mặc định ẩn) -->
                <li class="no-songs" style="display: none;">
                    <div class="message">
                        <i class="fas fa-info-circle"></i>
                        <span>Không có bài hát nào trong danh mục này.</span>
                    </div>
                </li>
            </ul>
        </main>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fab fa-google"></i>
                </div>
                <div class="login-section">
                    <button class="login-with-google-btn">
                        <i class="fab fa-google"></i> Đăng nhập bằng Google
                    </button>
                </div>
            </div>
        </div>
        <nav class="sidebar-menu">
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> Trang chủ</a></li>
                <li><a href="#" class="active"><i class="fas fa-music"></i> Bài hát</a></li>
                <li><a href="#"><i class="fas fa-book"></i> Khóa học</a></li>
                <li><a href="#"><i class="fas fa-list"></i> Playlist của tôi</a></li>
                <li><a href="#"><i class="fas fa-heart"></i> Yêu thích</a></li>
                <li><a href="#"><i class="fas fa-search"></i> Tìm theo hợp âm</a></li>
                <li><a href="#"><i class="fas fa-guitar"></i> Tra cứu hợp âm</a></li>
                <li><a href="index.html#donate"><i class="fas fa-hand-holding-heart"></i> Đóng góp</a></li>
                <li><a href="feedback.html"><i class="fas fa-comment-dots"></i> Góp ý</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> Thiết lập</a></li>
            </ul>
        </nav>
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- Firebase App (cần thiết cho tất cả các sản phẩm của Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    
    <!-- Thêm các SDK Firebase mà bạn muốn sử dụng -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Scripts tùy chỉnh -->
    <script src="js/firebase-auth.js"></script>
    <script src="js/firestore-operations.js"></script>
    <script src="js/script.js"></script>
    
    <!-- Firebase initialization -->
    <script>
        // Khởi tạo Firebase với cấu hình từ firebase-constants.js
        document.addEventListener('DOMContentLoaded', function() {
            // Lấy cấu hình từ firebase-constants.js
            const firebaseConfig = window.getFirebaseConfig();
            
            // Khởi tạo Firebase nếu chưa được khởi tạo
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log('Firebase đã được khởi tạo thành công từ firebase-constants.js');
                
                // Khởi tạo Analytics nếu có id
                if (firebaseConfig.measurementId) {
                    firebase.analytics();
                }
            }
        });
    </script>
    
    <!-- Script xử lý danh sách bài hát -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Đảm bảo rằng các hàm Firestore đã được tải
            if (!window.firestoreOperations) {
                console.error('Firestore operations chưa được tải');
                return;
            }
            
            // Lấy ID danh mục từ URL hoặc sử dụng một danh mục mặc định
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('category') || 'nhac-vang';
            
            try {
                // Tải danh sách bài hát từ Firestore
                const songs = await window.firestoreOperations.getSongsByCategory(categoryId);
                
                if (songs.length > 0) {
                    // Cập nhật tiêu đề danh mục
                    document.querySelector('.list-header h2').textContent = songs[0].categoryName || 'Danh sách bài hát';
                    
                    // Xóa danh sách bài hát hiện tại
                    const songsList = document.querySelector('.songs');
                    songsList.innerHTML = '';
                    
                    // Thêm các bài hát vào danh sách
                    songs.forEach(song => {
                        const songItem = createSongItem(song);
                        songsList.appendChild(songItem);
                    });
                    
                    // Thêm xử lý sự kiện cho các nút yêu thích
                    setupFavoriteButtons();
                } else {
                    // Hiển thị thông báo nếu không có bài hát
                    const songsList = document.querySelector('.songs');
                    songsList.innerHTML = '<li class="no-songs">Không có bài hát nào trong danh mục này.</li>';
                }
            } catch (error) {
                console.error('Lỗi khi tải danh sách bài hát:', error);
            }
        });
        
        // Tạo HTML cho một mục bài hát
        function createSongItem(song) {
            const li = document.createElement('li');
            li.className = 'song-item';
            li.dataset.id = song.id;
            
            const html = `
                <div class="song-info">
                    <div class="song-title">${song.title}</div>
                </div>
                <button class="favorite-btn" data-song-id="${song.id}">
                    <i class="far fa-heart"></i>
                </button>
            `;
            
            li.innerHTML = html;
            
            // Thêm sự kiện click để chuyển đến trang chi tiết
            li.addEventListener('click', (event) => {
                // Không chuyển trang nếu click vào nút yêu thích
                if (!event.target.closest('.favorite-btn')) {
                    window.location.href = `song-detail.html?id=${song.id}`;
                }
            });
            
            return li;
        }
        
        // Thiết lập xử lý sự kiện cho các nút yêu thích
        async function setupFavoriteButtons() {
            const favoriteButtons = document.querySelectorAll('.favorite-btn');
            
            favoriteButtons.forEach(button => {
                const songId = button.dataset.songId;
                
                // Kiểm tra trạng thái yêu thích ban đầu
                window.firestoreOperations.checkFavoriteStatus(songId).then(isFavorite => {
                    const icon = button.querySelector('i');
                    if (isFavorite) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    }
                });
                
                // Xử lý sự kiện click
                button.addEventListener('click', async (event) => {
                    event.stopPropagation(); // Ngăn sự kiện click lan ra phần tử cha
                    
                    try {
                        const isFavorite = await window.firestoreOperations.toggleFavoriteSong(songId);
                        const icon = button.querySelector('i');
                        
                        if (isFavorite === true) {
                            // Đã thêm vào yêu thích
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            window.firebaseUtils.showAlert('Đã thêm vào danh sách yêu thích', 'success');
                        } else if (isFavorite === false) {
                            // Đã xóa khỏi yêu thích
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            window.firebaseUtils.showAlert('Đã xóa khỏi danh sách yêu thích', 'info');
                        }
                    } catch (error) {
                        console.error('Lỗi khi thay đổi trạng thái yêu thích:', error);
                        window.firebaseUtils.showAlert('Đã xảy ra lỗi khi cập nhật trạng thái yêu thích', 'error');
                    }
                });
            });
        }
    </script>
    
    <script src="js/google-auth.js"></script>
    <script src="js/firestore-operations.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo sự kiện đăng nhập
            if (typeof attachLoginEvents === 'function') {
                attachLoginEvents();
            } else {
                // Đợi nếu Google Auth script chưa được tải
                setTimeout(function() {
                    if (typeof attachLoginEvents === 'function') {
                        attachLoginEvents();
                    }
                }, 1000);
            }
            
            // Thiết lập tương tác với các phần tử
            setupInteractions();
            
            // Tải danh sách bài hát
            loadSongsList();
        });
        
        // Thiết lập tương tác
        function setupInteractions() {
            // Nút menu cho mobile
            const menuBtn = document.getElementById('menu-btn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (menuBtn && sidebar && overlay) {
                menuBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                    // Cập nhật avatar trong sidebar khi mở sidebar
                    updateSidebarAvatar();
                });
                
                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
            
            // Nút back
            const backBtn = document.querySelector('.back-btn');
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    window.history.back();
                });
            }
        }
        
        // Cập nhật avatar trong sidebar
        function updateSidebarAvatar() {
            try {
                // Lấy thông tin người dùng từ localStorage
                const userDataStr = localStorage.getItem('userData');
                if (userDataStr) {
                    const userData = JSON.parse(userDataStr);
                    
                    // Tìm avatar và login section trong sidebar
                    const sidebarAvatar = document.querySelector('.sidebar .user-avatar');
                    const loginSection = document.querySelector('.sidebar .login-section');
                    
                    if (sidebarAvatar && loginSection) {
                        // Xóa nội dung cũ
                        sidebarAvatar.innerHTML = '';
                        
                        // Hiển thị avatar người dùng
                        if (userData.picture) {
                            const avatar = document.createElement('img');
                            avatar.src = userData.picture;
                            avatar.alt = userData.name;
                            avatar.className = 'avatar-img';
                            sidebarAvatar.appendChild(avatar);
                        } else {
                            // Nếu không có ảnh, hiển thị chữ cái đầu của tên người dùng
                            const initial = document.createElement('div');
                            initial.className = 'avatar-initial';
                            initial.textContent = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
                            sidebarAvatar.appendChild(initial);
                        }
                        
                        // Ẩn section đăng nhập
                        loginSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật avatar sidebar:', error);
            }
        }
        
        // Tải danh sách bài hát từ Firestore
        function loadSongsList() {
            try {
                // Kiểm tra xem Firestore đã được khởi tạo chưa
                if (typeof isFirestoreInitialized === 'function') {
                    if (!isFirestoreInitialized()) {
                        initFirestore();
                    }
                    
                    // Lấy tham chiếu đến collection bài hát
                    const songsCollection = firebase.firestore().collection('songs');
                    
                    // Hiển thị loading
                    const songsList = document.querySelector('.songs');
                    const loadingItem = document.querySelector('.loading-item');
                    const noSongsMessage = document.querySelector('.no-songs');
                    
                    // Truy vấn Firestore
                    songsCollection.get().then((querySnapshot) => {
                        // Kiểm tra xem có kết quả nào không
                        if (querySnapshot.empty) {
                            // Ẩn loading, hiển thị thông báo không có bài hát
                            if (loadingItem) loadingItem.style.display = 'none';
                            if (noSongsMessage) noSongsMessage.style.display = 'flex';
                            return;
                        }
                        
                        // Xóa loading
                        if (loadingItem) loadingItem.remove();
                        
                        // Tạo phần tử mới cho mỗi bài hát
                        querySnapshot.forEach((doc) => {
                            const songData = doc.data();
                            const songId = doc.id;
                            
                            // Tạo phần tử bài hát
                            const songItem = document.createElement('li');
                            songItem.className = 'song-item';
                            
                            // Cấu trúc HTML cho mỗi bài hát
                            songItem.innerHTML = `
                                <a href="song-detail.html?id=${songId}" class="song-link">
                                    <div class="song-info">
                                        <h3 class="song-title">${songData.title || 'Không tiêu đề'}</h3>
                                        <p class="song-artist">${songData.artist || 'Không nghệ sĩ'}</p>
                                    </div>
                                    <div class="song-meta">
                                        <span class="song-key">${songData.key || 'C'}</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>
                            `;
                            
                            // Thêm vào danh sách
                            songsList.appendChild(songItem);
                        });
                    }).catch((error) => {
                        console.error("Lỗi khi tải danh sách bài hát:", error);
                        // Hiển thị thông báo lỗi
                        if (loadingItem) {
                            loadingItem.innerHTML = `
                                <div class="error-message">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span>Đã xảy ra lỗi khi tải danh sách bài hát. Vui lòng thử lại sau.</span>
                                </div>
                            `;
                        }
                    });
                } else {
                    console.error("Firestore không được khởi tạo");
                }
            } catch (error) {
                console.error("Lỗi khi tải danh sách bài hát:", error);
            }
        }
    </script>
</body>
</html> 